---
import { NAV_LINKS } from "@lib/constants";

const currentPath = Astro.url.pathname;
---

<header class="nav-header" id="main-nav">
  <nav class="nav-morph" id="nav-inner">
    <!-- Cursor spotlight overlay -->
    <div class="nav-spotlight" aria-hidden="true"></div>
    <!-- Glass inner shine -->
    <div class="nav-shine" aria-hidden="true"></div>

    <!-- Logo -->
    <a href="/" class="nav-logo" aria-label="Home">
      <span class="nav-logo-text">TK</span>
      <span class="nav-logo-dot"></span>
    </a>

    <!-- Divider -->
    <div class="nav-divider"></div>

    <!-- Nav links -->
    <div class="nav-links" id="nav-links">
      {
        NAV_LINKS.map((link) => (
          <a
            href={link.href}
            class:list={[
              "nav-link",
              currentPath.startsWith(link.href) && "nav-link-active",
            ]}
          >
            <span class="nav-link-text">{link.label}</span>
            <span class="nav-link-line" />
          </a>
        ))
      }
    </div>

    <!-- Mobile menu trigger -->
    <button class="nav-mobile-trigger md:hidden" id="mobile-menu-trigger" aria-label="Toggle menu">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 12h18M3 6h18M3 18h18" />
      </svg>
    </button>
  </nav>

  <!-- Mobile menu -->
  <div class="md:hidden fixed inset-0 z-40 hidden" id="mobile-menu" aria-hidden="true">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="mobile-menu-backdrop"></div>
    <div class="absolute right-4 top-20 w-52 card p-4">
      <div class="flex flex-col gap-1">
        {
          NAV_LINKS.map((link) => (
            <a
              href={link.href}
              class:list={[
                "text-sm px-3 py-2 rounded-lg transition-colors duration-200",
                currentPath.startsWith(link.href)
                  ? "text-accent bg-accent/5"
                  : "text-text-muted hover:text-text-secondary hover:bg-white/[0.03]",
              ]}
            >
              {link.label}
            </a>
          ))
        }
      </div>
    </div>
  </div>
</header>

<style>
  /* ─── Animated gradient border angle ─── */
  @property --border-angle {
    syntax: "<angle>";
    inherits: false;
    initial-value: 0turn;
  }

  /* ─── Header entry + positioning ─── */
  .nav-header {
    position: fixed;
    z-index: 50;
    padding: 1rem;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    animation: nav-enter 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
  }

  @keyframes nav-enter {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); filter: blur(6px); }
    to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
  }

  /* When collapsed to top-right corner */
  .nav-header.collapsed {
    justify-content: flex-end;
    padding: 0.75rem 1rem;
  }

  /* ─── Nav pill with animated gradient border ─── */
  .nav-morph {
    position: relative;
    display: flex;
    align-items: center;
    border-radius: 9999px;
    padding: 8px 22px;
    overflow: hidden;

    /* Animated conic gradient border */
    --border-angle: 0turn;
    background:
      linear-gradient(rgba(0, 0, 0, 0.78), rgba(0, 0, 0, 0.78)) padding-box,
      conic-gradient(
        from var(--border-angle),
        transparent 25%,
        rgba(201, 160, 74, 0.4) 37%,
        rgba(78, 205, 196, 0.3) 50%,
        rgba(167, 139, 250, 0.3) 62%,
        transparent 75%
      ) border-box;
    border: 1px solid transparent;
    animation: nav-border-spin 6s linear infinite;

    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.04);
    transition: padding 0.5s cubic-bezier(0.16, 1, 0.3, 1),
                box-shadow 0.5s ease;
  }

  @keyframes nav-border-spin {
    to { --border-angle: 1turn; }
  }

  .nav-morph:hover {
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(201, 160, 74, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.06);
  }

  .nav-header.collapsed .nav-morph {
    padding: 6px 12px;
    background:
      linear-gradient(rgba(0, 0, 0, 0.92), rgba(0, 0, 0, 0.92)) padding-box,
      conic-gradient(
        from var(--border-angle),
        transparent 20%,
        rgba(201, 160, 74, 0.5) 35%,
        rgba(78, 205, 196, 0.4) 50%,
        rgba(167, 139, 250, 0.4) 65%,
        transparent 80%
      ) border-box;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5),
                0 0 24px rgba(201, 160, 74, 0.08);
  }

  /* ─── Cursor spotlight overlay ─── */
  .nav-spotlight {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: radial-gradient(
      140px circle at var(--spot-x, 50%) var(--spot-y, 50%),
      rgba(201, 160, 74, 0.07),
      transparent 60%
    );
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1;
  }

  .nav-morph:hover .nav-spotlight {
    opacity: 1;
  }

  /* ─── Glass inner shine ─── */
  .nav-shine {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.06) 0%,
      transparent 40%,
      transparent 60%,
      rgba(255, 255, 255, 0.02) 100%
    );
    pointer-events: none;
    z-index: 1;
  }

  /* ─── Logo ─── */
  .nav-logo {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    flex-shrink: 0;
  }

  .nav-logo-text {
    font-family: var(--font-heading);
    font-size: 15px;
    font-weight: 700;
    color: var(--color-accent);
    letter-spacing: -0.02em;
    transition: all 0.3s ease;
  }

  .nav-logo:hover .nav-logo-text {
    text-shadow: 0 0 14px rgba(201, 160, 74, 0.5);
  }

  .nav-logo-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--color-accent);
    animation: dot-color 10s ease-in-out infinite;
    transition: box-shadow 0.3s ease;
  }

  .nav-logo:hover .nav-logo-dot {
    box-shadow: 0 0 10px currentColor;
  }

  @keyframes dot-color {
    0%, 100% { background: #C9A04A; }
    17% { background: #4ECDC4; }
    33% { background: #FF6B6B; }
    50% { background: #A78BFA; }
    67% { background: #34D399; }
    83% { background: #F59E0B; }
  }

  .nav-header.collapsed .nav-logo-dot {
    animation: dot-color 4s ease-in-out infinite, pulse-dot 2s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: 0 0 10px rgba(201, 160, 74, 0.6); }
  }

  /* ─── Divider ─── */
  .nav-divider {
    position: relative;
    z-index: 2;
    width: 1px;
    height: 16px;
    background: rgba(255, 255, 255, 0.08);
    margin: 0 16px;
    flex-shrink: 0;
    transition: all 0.4s ease;
  }

  .nav-header.collapsed .nav-divider {
    width: 0;
    margin: 0;
    opacity: 0;
  }

  .nav-header.collapsed:hover .nav-divider {
    width: 1px;
    margin: 0 16px;
    opacity: 1;
  }

  /* ─── Links ─── */
  .nav-links {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 22px;
    overflow: hidden;
    transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    opacity: 1;
    max-width: 500px;
  }

  .nav-header.collapsed .nav-links {
    max-width: 0;
    gap: 0;
    opacity: 0;
  }

  .nav-header.collapsed:hover .nav-links {
    max-width: 500px;
    gap: 22px;
    opacity: 1;
  }

  .nav-link {
    position: relative;
    font-size: 13px;
    color: var(--color-text-muted);
    white-space: nowrap;
    transition: color 0.25s ease;
    padding-bottom: 2px;
    z-index: 2;
  }

  .nav-link-text {
    position: relative;
    z-index: 1;
  }

  .nav-link:hover {
    color: var(--color-text-primary);
  }

  /* Animated underline on hover */
  .nav-link-line {
    position: absolute;
    bottom: -2px;
    left: 50%;
    width: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--color-accent), transparent);
    transition: width 0.3s cubic-bezier(0.16, 1, 0.3, 1), left 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    border-radius: 1px;
  }

  .nav-link:hover .nav-link-line {
    width: 100%;
    left: 0;
  }

  .nav-link-active {
    color: var(--color-accent);
  }

  .nav-link-active .nav-link-line {
    width: 60%;
    left: 20%;
    background: var(--color-accent);
    box-shadow: 0 0 6px rgba(201, 160, 74, 0.4);
  }

  /* ─── Mobile trigger ─── */
  .nav-mobile-trigger {
    position: relative;
    z-index: 2;
    color: var(--color-text-muted);
    padding: 4px;
    margin-left: 10px;
    flex-shrink: 0;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .nav-mobile-trigger:hover {
    color: var(--color-accent);
  }

  .nav-header.collapsed .nav-mobile-trigger {
    max-width: 0;
    margin-left: 0;
    opacity: 0;
    overflow: hidden;
  }

  .nav-header.collapsed:hover .nav-mobile-trigger {
    max-width: 24px;
    margin-left: 10px;
    opacity: 1;
  }

  @media (min-width: 768px) {
    .nav-mobile-trigger { display: none; }
  }

  @media (max-width: 767px) {
    .nav-links { display: none; }
    .nav-header.collapsed:hover .nav-links { display: none; }
    .nav-divider { display: none; }
  }
</style>

<script>
  const header = document.getElementById("main-nav");
  const nav = document.getElementById("nav-inner");
  let ticking = false;
  let isCollapsed = false;

  // ─── Cursor spotlight tracking ───
  if (nav) {
    nav.addEventListener("mousemove", (e) => {
      const rect = nav.getBoundingClientRect();
      nav.style.setProperty("--spot-x", `${e.clientX - rect.left}px`);
      nav.style.setProperty("--spot-y", `${e.clientY - rect.top}px`);
    });
  }

  // ─── Scroll collapse ───
  function handleScroll() {
    if (!header || !nav) return;
    const shouldCollapse = window.scrollY > 80;

    if (shouldCollapse && !isCollapsed) {
      isCollapsed = true;
      header.classList.add("collapsed");
    } else if (!shouldCollapse && isCollapsed) {
      isCollapsed = false;
      header.classList.remove("collapsed");
    }

    ticking = false;
  }

  window.addEventListener("scroll", () => {
    if (!ticking) { requestAnimationFrame(handleScroll); ticking = true; }
  }, { passive: true });
  handleScroll();

  // ─── Mobile menu ───
  const trigger = document.getElementById("mobile-menu-trigger");
  const menu = document.getElementById("mobile-menu");
  const backdrop = document.getElementById("mobile-menu-backdrop");
  function toggleMenu() {
    if (menu) {
      const isHidden = menu.classList.contains("hidden");
      menu.classList.toggle("hidden");
      menu.setAttribute("aria-hidden", String(!isHidden));
    }
  }
  trigger?.addEventListener("click", toggleMenu);
  backdrop?.addEventListener("click", toggleMenu);
</script>
