---
import PageLayout from "@layouts/PageLayout.astro";
import GlassCard from "@components/cards/GlassCard.astro";
import Badge from "@components/ui/Badge.astro";
import { getCollection } from "astro:content";
import { formatDate, readingTime } from "@lib/utils";
import { SITE, PUBLICATION } from "@lib/constants";

import BlurReveal from "@components/islands/BlurReveal";
import StaggerReveal from "@components/islands/StaggerReveal";

const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": PUBLICATION.name,
  "description": PUBLICATION.description,
  "url": `${SITE.url}/blog`,
  "author": {
    "@type": "Person",
    "name": SITE.author,
    "url": SITE.url,
  },
  "publisher": {
    "@type": "Organization",
    "name": PUBLICATION.name,
    "url": `${SITE.url}/blog`,
  },
  "blogPost": posts.map((post) => ({
    "@type": "BlogPosting",
    "headline": post.data.title,
    "url": `${SITE.url}/blog/${post.id}`,
    "datePublished": post.data.date.toISOString(),
  })),
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": SITE.url },
    { "@type": "ListItem", "position": 2, "name": "Blog", "item": `${SITE.url}/blog` },
  ],
};
---

<PageLayout title={`${PUBLICATION.name} â€” Blog`} description={PUBLICATION.description}>
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <section class="py-12">
    <p class="text-[11px] font-mono text-text-muted uppercase tracking-[0.2em] mb-3"
       style="opacity: 0; animation: fade-up 0.5s ease-out 0.2s forwards;">
      {PUBLICATION.name}
    </p>
    <BlurReveal
      client:idle
      text={PUBLICATION.tagline}
      className="text-3xl font-heading font-medium text-text-primary mb-2 tracking-tight capitalize"
      as="h1"
    />
    <p
      class="text-text-muted mb-10"
      style="opacity: 0; animation: fade-up 0.5s ease-out 0.4s forwards;"
    >
      {PUBLICATION.description}
    </p>

    <StaggerReveal client:visible className="grid gap-4" stagger={0.1}>
      {
        posts.map((post) => (
          <GlassCard href={`/blog/${post.id}`} class="group" padding="lg">
            <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex flex-wrap items-center gap-2 mb-3">
                  {post.data.tags.map((tag) => (
                    <Badge variant="outline">{tag}</Badge>
                  ))}
                </div>
                <h2 class="text-lg font-heading font-medium text-text-primary group-hover:text-accent transition-colors">
                  {post.data.title}
                </h2>
                <p class="mt-2 text-sm text-text-muted line-clamp-2">
                  {post.data.description}
                </p>
              </div>
              <div class="text-xs text-text-muted whitespace-nowrap font-mono text-right">
                <div>{formatDate(post.data.date)}</div>
                <div class="mt-1 text-text-muted/60">{readingTime(post.body ?? "")} min read</div>
              </div>
            </div>
          </GlassCard>
        ))
      }

      {posts.length === 0 && (
        <div class="card rounded-2xl p-12 text-center">
          <p class="text-text-muted">No posts yet. Check back soon.</p>
        </div>
      )}
    </StaggerReveal>
  </section>
</PageLayout>
