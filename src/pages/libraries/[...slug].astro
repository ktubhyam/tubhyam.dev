---
import ProseLayout from "@layouts/ProseLayout.astro";
import Badge from "@components/ui/Badge.astro";
import GlassButton from "@components/ui/GlassButton.astro";
import { getCollection, render } from "astro:content";
import { SITE } from "@lib/constants";

export async function getStaticPaths() {
  const libraries = await getCollection("libraries");
  return libraries.map((lib) => ({
    params: { slug: lib.id },
    props: { lib },
  }));
}

const { lib } = Astro.props;
const { Content } = await render(lib);

const canonicalUrl = new URL(`/libraries/${lib.id}`, SITE.url).toString();

const softwareSchema = {
  "@context": "https://schema.org",
  "@type": "SoftwareSourceCode",
  "name": lib.data.title,
  "description": lib.data.description,
  "programmingLanguage": lib.data.language,
  "codeRepository": lib.data.github,
  ...(lib.data.pypi && {
    "installUrl": `https://pypi.org/project/${lib.data.pypi}/`,
  }),
  ...(lib.data.docs && { "url": lib.data.docs }),
  "author": {
    "@type": "Person",
    "name": SITE.author,
    "url": SITE.url,
    "sameAs": [SITE.github, SITE.twitter, SITE.linkedin],
  },
  "license": "https://opensource.org/licenses/MIT",
  "keywords": lib.data.tags?.join(", ") ?? "",
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": SITE.url },
    { "@type": "ListItem", "position": 2, "name": "Libraries", "item": `${SITE.url}/libraries` },
    { "@type": "ListItem", "position": 3, "name": lib.data.title, "item": canonicalUrl },
  ],
};
---

<ProseLayout title={lib.data.title} description={lib.data.description}>
  <script type="application/ld+json" set:html={JSON.stringify(softwareSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <header class="mb-12 not-prose">
    <div class="flex items-center gap-2">
      <Badge>{lib.data.language}</Badge>
      <Badge variant="outline">{lib.data.status}</Badge>
    </div>
    <h1 class="mt-4 text-4xl font-heading font-bold text-text-primary">
      {lib.data.title}
    </h1>
    <p class="mt-2 text-text-secondary">{lib.data.description}</p>
    <div class="mt-6 flex flex-wrap gap-3">
      <GlassButton href={lib.data.github}>GitHub</GlassButton>
      {lib.data.docs && (
        <GlassButton href={lib.data.docs} variant="secondary">Docs</GlassButton>
      )}
    </div>
  </header>

  <Content />
</ProseLayout>
