---
import { NAV_LINKS } from "@lib/constants";

const currentPath = Astro.url.pathname;
---

<header class="nav-header" id="main-nav">
  <nav class="nav-terminal" id="nav-inner">
    <!-- Window controls -->
    <div class="nav-dots" aria-hidden="true">
      <span class="dot dot-red"></span>
      <span class="dot dot-yellow"></span>
      <span class="dot dot-green"></span>
    </div>

    <!-- Prompt -->
    <a href="/" class="nav-prompt" aria-label="Home">
      <span class="nav-prompt-symbol">~</span>
      <span class="nav-prompt-path">tubhyam.dev</span>
      <span class="nav-cursor"></span>
    </a>

    <!-- Divider -->
    <div class="nav-pipe" aria-hidden="true">|</div>

    <!-- Nav links -->
    <div class="nav-links" id="nav-links">
      {
        NAV_LINKS.map((link) => (
          <a
            href={link.href}
            class:list={[
              "nav-link",
              currentPath.startsWith(link.href) && "nav-link-active",
            ]}
          >
            {link.label.toLowerCase()}
          </a>
        ))
      }
    </div>

    <!-- Mobile menu trigger -->
    <button class="nav-mobile-trigger md:hidden" id="mobile-menu-trigger" aria-label="Toggle menu">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 12h18M3 6h18M3 18h18" />
      </svg>
    </button>
  </nav>

  <!-- Mobile menu -->
  <div class="md:hidden fixed inset-0 z-40 hidden" id="mobile-menu" aria-hidden="true">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="mobile-menu-backdrop"></div>
    <div class="mobile-dropdown">
      <div class="mobile-dropdown-header">
        <span class="dot dot-red" style="width:6px;height:6px;"></span>
        <span class="dot dot-yellow" style="width:6px;height:6px;"></span>
        <span class="dot dot-green" style="width:6px;height:6px;"></span>
        <span class="mobile-dropdown-title">navigation</span>
      </div>
      <div class="mobile-dropdown-links">
        {
          NAV_LINKS.map((link) => (
            <a
              href={link.href}
              class:list={[
                "mobile-link",
                currentPath.startsWith(link.href) && "mobile-link-active",
              ]}
            >
              <span class="mobile-link-arrow">{currentPath.startsWith(link.href) ? "▸" : " "}</span>
              {link.label.toLowerCase()}
            </a>
          ))
        }
      </div>
    </div>
  </div>
</header>

<style>
  /* ─── Header positioning ─── */
  .nav-header {
    position: fixed;
    z-index: 50;
    padding: 0.75rem 1rem;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    animation: nav-enter 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.15s both;
  }

  @keyframes nav-enter {
    from { opacity: 0; transform: translateY(-12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .nav-header.collapsed {
    justify-content: flex-end;
    padding: 0.5rem 1rem;
  }

  /* ─── Terminal bar ─── */
  .nav-terminal {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 7px 16px;
    border-radius: 6px;
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    font-family: var(--font-mono);
    font-size: 13px;
    transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .nav-terminal:hover {
    border-color: #252525;
  }

  .nav-header.collapsed .nav-terminal {
    padding: 5px 12px;
  }

  /* ─── Window dots ─── */
  .nav-dots {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    transition: opacity 0.3s ease;
  }

  .dot-red { background: #FF5F57; }
  .dot-yellow { background: #FEBC2E; }
  .dot-green { background: #28C840; }

  .nav-header.collapsed .nav-dots .dot-yellow,
  .nav-header.collapsed .nav-dots .dot-green {
    width: 0;
    opacity: 0;
    margin: 0;
  }

  .nav-header.collapsed:hover .nav-dots .dot-yellow,
  .nav-header.collapsed:hover .nav-dots .dot-green {
    width: 8px;
    opacity: 1;
  }

  /* ─── Prompt ─── */
  .nav-prompt {
    display: flex;
    align-items: center;
    gap: 0;
    text-decoration: none;
    flex-shrink: 0;
    color: var(--color-text-muted);
    transition: color 0.2s ease;
  }

  .nav-prompt:hover {
    color: var(--color-text-secondary);
  }

  .nav-prompt-symbol {
    color: var(--color-accent);
    margin-right: 3px;
    font-weight: 500;
  }

  .nav-prompt-path {
    color: var(--color-text-secondary);
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  .nav-prompt:hover .nav-prompt-path {
    color: var(--color-text-primary);
  }

  .nav-cursor {
    display: inline-block;
    width: 7px;
    height: 14px;
    background: var(--color-accent);
    margin-left: 2px;
    opacity: 0.8;
    animation: cursor-blink 1.2s step-end infinite;
  }

  @keyframes cursor-blink {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 0; }
  }

  .nav-header.collapsed .nav-prompt-path {
    max-width: 0;
    overflow: hidden;
    opacity: 0;
  }

  .nav-header.collapsed:hover .nav-prompt-path {
    max-width: 100px;
    opacity: 1;
  }

  .nav-prompt-path {
    transition: max-width 0.4s cubic-bezier(0.16, 1, 0.3, 1),
                opacity 0.3s ease,
                color 0.2s ease;
    max-width: 100px;
    overflow: hidden;
    white-space: nowrap;
  }

  .nav-header.collapsed .nav-cursor {
    animation: cursor-blink 0.8s step-end infinite;
  }

  /* ─── Pipe divider ─── */
  .nav-pipe {
    color: #333;
    font-size: 14px;
    flex-shrink: 0;
    user-select: none;
    transition: all 0.4s ease;
  }

  .nav-header.collapsed .nav-pipe {
    width: 0;
    opacity: 0;
    overflow: hidden;
  }

  .nav-header.collapsed:hover .nav-pipe {
    width: auto;
    opacity: 1;
  }

  /* ─── Links ─── */
  .nav-links {
    display: flex;
    align-items: center;
    gap: 16px;
    overflow: hidden;
    transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    opacity: 1;
    max-width: 400px;
  }

  .nav-header.collapsed .nav-links {
    max-width: 0;
    gap: 0;
    opacity: 0;
  }

  .nav-header.collapsed:hover .nav-links {
    max-width: 400px;
    gap: 16px;
    opacity: 1;
  }

  .nav-link {
    color: #888;
    font-size: 13px;
    white-space: nowrap;
    transition: color 0.2s ease;
    text-decoration: none;
    letter-spacing: 0.01em;
  }

  .nav-link:hover {
    color: var(--color-text-primary);
  }

  .nav-link-active {
    color: var(--color-accent);
  }

  /* ─── Mobile trigger ─── */
  .nav-mobile-trigger {
    color: #888;
    padding: 2px;
    flex-shrink: 0;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .nav-mobile-trigger:hover {
    color: var(--color-accent);
  }

  .nav-header.collapsed .nav-mobile-trigger {
    max-width: 0;
    opacity: 0;
    overflow: hidden;
  }

  .nav-header.collapsed:hover .nav-mobile-trigger {
    max-width: 20px;
    opacity: 1;
  }

  @media (min-width: 768px) {
    .nav-mobile-trigger { display: none; }
  }

  @media (max-width: 767px) {
    .nav-links { display: none; }
    .nav-header.collapsed:hover .nav-links { display: none; }
    .nav-pipe { display: none; }
  }

  /* ─── Mobile dropdown ─── */
  .mobile-dropdown {
    position: absolute;
    right: 1rem;
    top: 4.5rem;
    width: 200px;
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    border-radius: 8px;
    overflow: hidden;
    font-family: var(--font-mono);
  }

  .mobile-dropdown-header {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    border-bottom: 1px solid #1a1a1a;
  }

  .mobile-dropdown-title {
    font-size: 11px;
    color: #888;
    margin-left: 6px;
  }

  .mobile-dropdown-links {
    padding: 6px 0;
  }

  .mobile-link {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    font-size: 13px;
    color: #767676;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .mobile-link:hover {
    color: var(--color-text-primary);
    background: rgba(255, 255, 255, 0.03);
  }

  .mobile-link-arrow {
    color: var(--color-accent);
    font-size: 10px;
    width: 10px;
  }

  .mobile-link-active {
    color: var(--color-accent);
  }
</style>

<script>
  const header = document.getElementById("main-nav");
  const nav = document.getElementById("nav-inner");
  let ticking = false;
  let isCollapsed = false;

  // ─── Scroll collapse ───
  function handleScroll() {
    if (!header || !nav) return;
    const shouldCollapse = window.scrollY > 80;

    if (shouldCollapse && !isCollapsed) {
      isCollapsed = true;
      header.classList.add("collapsed");
    } else if (!shouldCollapse && isCollapsed) {
      isCollapsed = false;
      header.classList.remove("collapsed");
    }

    ticking = false;
  }

  window.addEventListener("scroll", () => {
    if (!ticking) { requestAnimationFrame(handleScroll); ticking = true; }
  }, { passive: true });
  handleScroll();

  // ─── Mobile menu ───
  const trigger = document.getElementById("mobile-menu-trigger");
  const menu = document.getElementById("mobile-menu");
  const backdrop = document.getElementById("mobile-menu-backdrop");
  function toggleMenu() {
    if (menu) {
      const isHidden = menu.classList.contains("hidden");
      menu.classList.toggle("hidden");
      menu.setAttribute("aria-hidden", String(!isHidden));
    }
  }
  trigger?.addEventListener("click", toggleMenu);
  backdrop?.addEventListener("click", toggleMenu);
</script>
