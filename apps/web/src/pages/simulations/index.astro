---
import PageLayout from "@layouts/PageLayout.astro";
import TerminalBreadcrumb from "@components/ui/TerminalBreadcrumb.astro";
import TerminalWindow from "@components/ui/TerminalWindow.astro";
import { getCollection } from "astro:content";
import { SITE } from "@lib/constants";

import BlurReveal from "@components/islands/BlurReveal";

import SymmetryExplorer from "@components/islands/SymmetryExplorer";
import VibeScopePreview from "@components/islands/VibeScopePreview";
import OrbitalDiagram from "@components/islands/OrbitalDiagram";
import SpectrumViz from "@components/islands/SpectrumViz";

const simulations = (await getCollection("simulations"))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const accentColors = ["#A78BFA", "#C9A04A", "#4ECDC4", "#34D399", "#60A5FA", "#FF6B6B"];

const difficultyColors: Record<string, string> = {
  beginner: "#34D399",
  intermediate: "#C9A04A",
  advanced: "#FF6B6B",
};

const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Simulations",
  "description": "Interactive physics and chemistry simulations in the browser.",
  "url": `${SITE.url}/simulations`,
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": simulations.length,
    "itemListElement": simulations.map((sim, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "url": sim.data.launch || `${SITE.url}/simulations/${sim.id}`,
      "name": sim.data.title,
    })),
  },
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": SITE.url },
    { "@type": "ListItem", "position": 2, "name": "Simulations", "item": `${SITE.url}/simulations` },
  ],
};
---

<PageLayout title="Simulations" description="Interactive physics and chemistry simulations in the browser.">
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <section class="py-12">
    <TerminalBreadcrumb segments={[{ label: "simulations" }]} />
    <BlurReveal
      client:idle
      text="Simulations"
      className="text-3xl font-heading font-medium text-text-primary mb-2 tracking-tight"
      as="h1"
    />
    <p
      class="text-text-muted mb-10"
      style="opacity: 0; animation: fade-up 0.5s ease-out 0.4s forwards;"
    >
      Interactive experiments â€” explore physics and chemistry right in your browser.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {simulations.map((sim, i) => {
        const accent = accentColors[i % accentColors.length];
        const diffColor = difficultyColors[sim.data.difficulty] || "#555";
        const lineBase = 1;
        return (
          <a
            href={sim.data.launch || `/simulations/${sim.id}`}
            target={sim.data.launch ? "_blank" : undefined}
            rel={sim.data.launch ? "noopener noreferrer" : undefined}
            class="block no-underline group"
          >
            <TerminalWindow title={sim.id} status={sim.data.difficulty} statusColor={diffColor}>
              <div class="-m-5 mb-0">
                {sim.id === "symmetry-explorer" && (
                  <SymmetryExplorer client:visible className="rounded-none border-0" />
                )}
                {sim.id === "vibescope" && (
                  <VibeScopePreview client:visible className="rounded-none border-0" />
                )}
                {sim.id === "orbital-architect" && (
                  <OrbitalDiagram client:visible className="rounded-none border-0" />
                )}
                {sim.id === "normal-mode-explorer" && (
                  <SpectrumViz client:visible className="rounded-none border-0" />
                )}
                {sim.id === "spectrum-to-structure" && (
                  <SpectrumViz client:visible className="rounded-none border-0" title="Inverse Spectrum Analysis" />
                )}
                {sim.id === "spectraview-demo" && (
                  <SpectrumViz client:visible className="rounded-none border-0" title="SpectraView" />
                )}
              </div>
              <div class="border-t border-border -mx-5 px-5 pt-3 mt-3 font-mono text-xs md:text-sm">
                <div class="flex items-center">
                  <span class="w-6 text-right mr-3 select-none flex-shrink-0 text-[#333]">{lineBase}</span>
                  <span style={`color: ${accent}`} class="font-medium">{sim.data.title}</span>
                </div>
                <div class="flex items-center mt-0.5">
                  <span class="w-6 text-right mr-3 select-none flex-shrink-0 text-[#333]">{lineBase + 1}</span>
                  <span class="text-[#555]">{sim.data.description}</span>
                </div>
                <div class="flex items-center mt-0.5">
                  <span class="w-6 text-right mr-3 select-none flex-shrink-0 text-[#333]">{lineBase + 2}</span>
                  <span class="flex flex-wrap gap-1.5">
                    {sim.data.physics.map((p: string) => (
                      <span
                        class="text-[10px] font-mono px-1.5 py-0.5 rounded"
                        style={`color: ${accent}; background-color: ${accent}12; border: 1px solid ${accent}30;`}
                      >
                        {p}
                      </span>
                    ))}
                  </span>
                </div>
                <div class="flex items-center mt-1">
                  <span class="w-6 text-right mr-3 select-none flex-shrink-0 text-[#333]">{lineBase + 3}</span>
                  <span class="text-xs font-mono text-accent opacity-0 group-hover:opacity-100 transition-opacity">
                    {sim.data.launch ? "Launch" : "Open"} &rarr;
                  </span>
                </div>
              </div>
            </TerminalWindow>
          </a>
        );
      })}
    </div>

    {simulations.length === 0 && (
      <div class="card rounded-2xl p-12 text-center">
        <p class="text-text-muted">Simulations coming soon.</p>
      </div>
    )}
  </section>
</PageLayout>

<style>
  @keyframes fade-up {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
