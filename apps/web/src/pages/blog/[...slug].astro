---
import ProseLayout from "@layouts/ProseLayout.astro";
import TerminalWindow from "@components/ui/TerminalWindow.astro";
import TerminalBreadcrumb from "@components/ui/TerminalBreadcrumb.astro";
import TerminalSectionLabel from "@components/ui/TerminalSectionLabel.astro";
import { getCollection, render } from "astro:content";
import { formatDate, readingTime } from "@lib/utils";
import { SITE, PUBLICATION } from "@lib/constants";

import BlurReveal from "@components/islands/BlurReveal";
import NewsletterSubscribe from "@components/islands/NewsletterSubscribe";

export async function getStaticPaths() {
  const posts = (await getCollection("blog"))
    .filter((p) => !p.data.draft)
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
  return posts.map((post, i) => ({
    params: { slug: post.id },
    props: {
      post,
      prevPost: posts[i + 1] ?? null,
      nextPost: posts[i - 1] ?? null,
    },
  }));
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);

const minutes = readingTime(post.body ?? "");
const accentColors = ["#A78BFA", "#C9A04A", "#4ECDC4", "#34D399", "#60A5FA", "#FF6B6B"];
const canonicalUrl = new URL(`/blog/${post.id}`, SITE.url).toString();

const blogPostingSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description,
  "datePublished": post.data.date.toISOString(),
  ...(post.data.updated && { "dateModified": post.data.updated.toISOString() }),
  "url": canonicalUrl,
  "mainEntityOfPage": { "@type": "WebPage", "@id": canonicalUrl },
  "author": {
    "@type": "Person",
    "name": SITE.author,
    "url": SITE.url,
    "sameAs": [SITE.github, SITE.twitter, SITE.linkedin],
  },
  "publisher": {
    "@type": "Organization",
    "name": PUBLICATION.name,
    "url": `${SITE.url}/blog`,
  },
  "keywords": post.data.tags.join(", "),
  "image": new URL("/og/default.png", SITE.url).toString(),
  "inLanguage": "en",
  "wordCount": (post.body ?? "").trim().split(/\s+/).length,
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": SITE.url },
    { "@type": "ListItem", "position": 2, "name": "Blog", "item": `${SITE.url}/blog` },
    { "@type": "ListItem", "position": 3, "name": post.data.title, "item": canonicalUrl },
  ],
};
---

<ProseLayout
  title={post.data.title}
  description={post.data.description}
  ogType="article"
  publishedDate={post.data.date.toISOString()}
  modifiedDate={post.data.updated?.toISOString()}
  hasMath={true}
>
  <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <header class="mb-12 not-prose">
    <TerminalBreadcrumb segments={[{ label: "blog", href: "/blog" }, { label: post.data.title }]} />
    <div class="flex flex-wrap items-center gap-1.5 mb-4">
      {post.data.tags.map((tag: string, i: number) => {
        const color = accentColors[i % accentColors.length];
        return (
          <a
            href={`/tags/${tag}`}
            class="inline-flex items-center px-2 py-0.5 text-xs rounded-full font-mono hover:opacity-80 transition-opacity"
            style={`color: ${color}; background: ${color}15; border: 1px solid ${color}30;`}
          >
            {tag}
          </a>
        );
      })}
    </div>
    <BlurReveal
      client:idle
      text={post.data.title}
      className="text-3xl font-heading font-medium text-text-primary leading-tight tracking-tight"
      as="h1"
    />
    <div class="mt-4 flex items-center gap-4 text-sm text-text-muted font-mono">
      <time datetime={post.data.date.toISOString()}>
        {formatDate(post.data.date)}
      </time>
      <span class="text-border">·</span>
      <span>{minutes} min read</span>
      {post.data.updated && (
        <>
          <span class="text-border">·</span>
          <span>Updated {formatDate(post.data.updated)}</span>
        </>
      )}
    </div>
  </header>

  {tocHeadings.length >= 3 && (
    <nav class="not-prose mb-10 rounded-lg border border-[#1a1a1a] bg-[#0a0a0a] p-5">
      <TerminalSectionLabel text="table of contents" class="mb-3" />
      <ul class="space-y-1.5">
        {tocHeadings.map((h, i) => (
          <li style={h.depth === 3 ? "padding-left: 1rem;" : ""} class="flex items-center gap-2">
            <span class="text-[9px] font-mono text-[#333] w-3 text-right select-none">{i + 1}</span>
            <a
              href={`#${h.slug}`}
              class="text-sm text-text-muted hover:text-accent transition-colors duration-200 leading-relaxed"
            >
              {h.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )}

  <Content />

  {(prevPost || nextPost) && (
    <nav class="not-prose mt-16">
      <TerminalWindow title="navigation" status="blog" statusColor="#C9A04A">
        <div class="space-y-2">
          {prevPost && (
            <a href={`/blog/${prevPost.id}`} class="flex items-start gap-2 group py-1 hover:bg-[#A78BFA08] transition-colors rounded px-1 -mx-1">
              <span class="w-6 text-right mr-1 select-none flex-shrink-0 text-[#333] font-mono text-xs">1</span>
              <span class="text-[#A78BFA] font-mono text-xs select-none">←</span>
              <span class="text-xs font-mono">
                <span class="text-text-muted">prev:</span>
                <span class="text-[#A78BFA] group-hover:underline ml-1">{prevPost.data.title}</span>
              </span>
            </a>
          )}
          {nextPost && (
            <a href={`/blog/${nextPost.id}`} class="flex items-start gap-2 group py-1 hover:bg-[#4ECDC408] transition-colors rounded px-1 -mx-1">
              <span class="w-6 text-right mr-1 select-none flex-shrink-0 text-[#333] font-mono text-xs">{prevPost ? "2" : "1"}</span>
              <span class="text-[#4ECDC4] font-mono text-xs select-none">→</span>
              <span class="text-xs font-mono">
                <span class="text-text-muted">next:</span>
                <span class="text-[#4ECDC4] group-hover:underline ml-1">{nextPost.data.title}</span>
              </span>
            </a>
          )}
        </div>
      </TerminalWindow>
    </nav>
  )}

  <NewsletterSubscribe client:visible className="mt-12 not-prose" />
</ProseLayout>
