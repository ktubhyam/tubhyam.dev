---
import PageLayout from "@layouts/PageLayout.astro";
import TerminalBreadcrumb from "@components/ui/TerminalBreadcrumb.astro";
import TerminalSectionLabel from "@components/ui/TerminalSectionLabel.astro";
import { getCollection } from "astro:content";
import { readingTime } from "@lib/utils";
import { SITE, PUBLICATION } from "@lib/constants";

import BlurReveal from "@components/islands/BlurReveal";
import BlogListTerminal from "@components/islands/BlogListTerminal";
import NewsletterSubscribe from "@components/islands/NewsletterSubscribe";

const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const postsData = posts.map((post) => ({
  id: post.id,
  title: post.data.title,
  date: post.data.date.toISOString().split("T")[0],
  description: post.data.description,
  tags: post.data.tags,
  readingTime: readingTime(post.body ?? ""),
}));

const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": PUBLICATION.name,
  "description": PUBLICATION.description,
  "url": `${SITE.url}/blog`,
  "author": {
    "@type": "Person",
    "name": SITE.author,
    "url": SITE.url,
  },
  "publisher": {
    "@type": "Organization",
    "name": PUBLICATION.name,
    "url": `${SITE.url}/blog`,
  },
  "blogPost": posts.map((post) => ({
    "@type": "BlogPosting",
    "headline": post.data.title,
    "url": `${SITE.url}/blog/${post.id}`,
    "datePublished": post.data.date.toISOString(),
  })),
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": SITE.url },
    { "@type": "ListItem", "position": 2, "name": "Blog", "item": `${SITE.url}/blog` },
  ],
};
---

<PageLayout title={PUBLICATION.name} description={PUBLICATION.description}>
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <section class="py-12">
    <TerminalBreadcrumb segments={[{ label: "blog" }]} />
    <TerminalSectionLabel text={PUBLICATION.name} class="mb-3" />
    <BlurReveal
      client:idle
      text={PUBLICATION.tagline}
      className="text-3xl font-heading font-medium text-text-primary mb-2 tracking-tight capitalize"
      as="h1"
    />
    <p
      class="text-text-muted mb-8"
      style="opacity: 0; animation: fade-up 0.5s ease-out 0.4s forwards;"
    >
      {PUBLICATION.description}
    </p>

    <BlogListTerminal client:visible posts={postsData} />

    <NewsletterSubscribe client:idle className="mt-6" />
  </section>
</PageLayout>
