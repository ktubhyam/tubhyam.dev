---
import PageLayout from "@layouts/PageLayout.astro";
import TerminalBreadcrumb from "@components/ui/TerminalBreadcrumb.astro";
import TerminalWindow from "@components/ui/TerminalWindow.astro";
import { getCollection } from "astro:content";
import { SITE } from "@lib/constants";

import BlurReveal from "@components/islands/BlurReveal";

const libraries = (await getCollection("libraries"))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const accentColors = ["#A78BFA", "#C9A04A", "#4ECDC4", "#34D399", "#60A5FA", "#FF6B6B"];

const languageColors: Record<string, string> = {
  python: "#60A5FA",
  typescript: "#C9A04A",
  rust: "#FF6B6B",
};

const statusColors: Record<string, string> = {
  alpha: "#FF6B6B",
  beta: "#C9A04A",
  stable: "#34D399",
};

const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Libraries",
  "description": "Open-source libraries for spectroscopy, molecular analysis, and more.",
  "url": `${SITE.url}/libraries`,
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": libraries.length,
    "itemListElement": libraries.map((lib, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "url": `${SITE.url}/libraries/${lib.id}`,
      "name": lib.data.title,
    })),
  },
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": SITE.url },
    { "@type": "ListItem", "position": 2, "name": "Libraries", "item": `${SITE.url}/libraries` },
  ],
};
---

<PageLayout title="Libraries" description="Open-source libraries for spectroscopy, molecular analysis, and more.">
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <section class="py-12">
    <TerminalBreadcrumb segments={[{ label: "libraries" }]} />
    <BlurReveal
      client:idle
      text="Libraries"
      className="text-3xl font-heading font-medium text-text-primary mb-2 tracking-tight"
      as="h1"
    />
    <p
      class="text-text-muted mb-2"
      style="opacity: 0; animation: fade-up 0.5s ease-out 0.4s forwards;"
    >
      Open-source tools for computational science. Install, use, contribute.
    </p>
    <p class="text-[11px] font-mono text-[#333] mb-10"
       style="opacity: 0; animation: fade-up 0.5s ease-out 0.5s forwards;">
      {libraries.length} packages
    </p>

    <TerminalWindow title="~/packages" status={`${libraries.length} packages`}>
      <div class="mb-4 text-[#555]">
        <span class="text-[#34D399]">$</span> pip list && npm list
      </div>

      {libraries.length === 0 && (
        <div class="text-[#555]">No packages found.</div>
      )}

      {libraries.map((lib, i) => {
        const accent = accentColors[i % accentColors.length];
        const langColor = languageColors[lib.data.language] || "#555";
        const sColor = statusColors[lib.data.status] || "#555";
        const lineBase = i * 4 + 1;
        const installCmd = lib.data.pypi
          ? `pip install ${lib.data.pypi}`
          : lib.data.npm
            ? `npm install ${lib.data.npm}`
            : null;
        return (
          <a
            href={`/libraries/${lib.id}`}
            class="block -mx-5 px-5 py-2 no-underline transition-colors duration-150"
            style="border-left: 2px solid transparent;"
            data-accent={accent}
          >
            <div class="flex items-center">
              <span class="w-6 text-right mr-3 select-none flex-shrink-0 text-[#333]">{lineBase}</span>
              <span style={`color: ${langColor}`} class="text-xs font-mono mr-3">[{lib.data.language}]</span>
              <span style={`color: ${sColor}`} class="text-xs font-mono">{lib.data.status}</span>
            </div>
            <div class="flex items-center mt-0.5">
              <span class="w-6 text-right mr-3 select-none flex-shrink-0 text-[#333]">{lineBase + 1}</span>
              <span style={`color: ${accent}`} class="font-medium">{lib.data.title}</span>
            </div>
            <div class="flex items-center mt-0.5">
              <span class="w-6 text-right mr-3 select-none flex-shrink-0 text-[#333]">{lineBase + 2}</span>
              <span class="text-[#555]">{lib.data.description}</span>
            </div>
            {installCmd && (
              <div class="flex items-center mt-0.5">
                <span class="w-6 text-right mr-3 select-none flex-shrink-0 text-[#333]">{lineBase + 3}</span>
                <span class="text-[#34D399]">$ {installCmd}</span>
              </div>
            )}
          </a>
        );
      })}
    </TerminalWindow>
  </section>
</PageLayout>

<style>
  @keyframes fade-up {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
  document.querySelectorAll<HTMLAnchorElement>('a[data-accent]').forEach((el) => {
    const accent = el.dataset.accent || '#34D399';
    el.addEventListener('mouseenter', () => {
      el.style.borderLeftColor = accent;
      el.style.backgroundColor = accent + '08';
    });
    el.addEventListener('mouseleave', () => {
      el.style.borderLeftColor = 'transparent';
      el.style.backgroundColor = 'transparent';
    });
  });
</script>
